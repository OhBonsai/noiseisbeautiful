

程序化方法与动画堪称绝配。由于程序化纹理通常逐帧重新生成，图案的每个方面都能被动画化。程序化模型当然也可动画化（前提是实时生成），但这将留待本书第二部分讨论。本章聚焦动画纹理。

若想快速略过这个主题，我们大可以说"任何参数都能与时间关联"，其余则归于艺术而非技术范畴。但这就像舞蹈老师只告诉你"随意摆动身体部位直到好看"——合格的舞蹈教师至少会教些基础动作，具体指导该移动哪些身体部位及如何移动。动画确实关乎艺术表达和戏剧性节奏，但也涉及物理、视觉感知、数学和编程。做好动画所需的天赋与建模或纹理制作不同，鲜有人能精通所有领域，但在某些技术环节，工程方法能极大助力艺术家工作。本章旨在揭示这些技术要点。

## 基础参数

冒着陈述显而易见之事的风险，我们仍要列举程序化纹理中值得动画化的参数：

若图案具有"波动"特性，则其**振幅**（强度）、**频率**（尺度）和**相位**（由位置和时间决定）都可动画化以产生不同视觉效果。介质中传播的波动遵循已知物理定律，这些定律可用数学方程表达。例如计算机图形学界投入大量精力模拟水流运动，且仿真精度持续提升。但水面波纹的程序化纹理未必需要精确的流体仿真模型求解微分方程——仿真可以高度近似，甚至完全用简单参数动画替代。这类参数动画可全部或部分基于对水波外观的经验认知，而非建模其形成、传播和发展的物理过程。关键在于让运动看起来足够好，不必完全符合现实。有时夸张或完全非物理的运动反而更理想，而调整仿真模型实现这种效果可能极其困难。基于参数的"伪"动画则无此限制，赋予更大艺术自由。

别忘了传统计算机图形学中所有可映射和动画的参数（强度、颜色、透明度、高光等）同样适用于程序化纹理。当然，纹理坐标也能自由动画化（扭曲）——只要能用代码表达。这个实用选项常被忽视。

## 速度与尺度

运动能为场景赋予强烈的尺度感。小而轻的物体运动停止迅速，大而重的物体运动则相对自身尺寸更缓慢（即使绝对速度可观），且因动能更大需要更多时间和力（力学称为更大*冲量*）来改变方向或减速。小水纹快速移动，撞击影响小且易消散；而大洋波浪缓慢庄严地推进，冲击力惊人，传播距离遥远。大型物体坠落倾倒时，其相对尺寸的运动速度比小物体更慢。

动画时机把握不当会造成尺度错位，彻底破坏真实感。但吊诡的是，反之亦然——某些动画若采用物理精确的时序反而显得虚假，火焰动画尤其如此。小火苗的实际运动比大众预期狂野迅捷得多。有人将此归咎于迪士尼——这不无道理。卡通渲染的烛光或壁炉塑造了我们对火焰的认知，导致我们不仅接受慢动作渲染的火焰，还觉得它更"温馨"美观。

## 将时间误作空间处理

制作动画图案的有力工具是动态噪声——噪声图案随时间渐变。传统方法是在更高维噪声中切取切片，并随时间移动切片位置。这虽有效，但会引入大量低频成分，破坏噪声的带限特性。

多维信号处理中的*投影切片定理*解释了这点，但深入理解需频域分析。简言之，当用2D切片截取3D噪声函数时，可能恰好以近直角切入噪声波动的梯度中心区域，导致该切片区域呈现无特征平面。同样情况也发生在4D噪声的3D"切片"或2D函数的1D切片上。虽非致命缺陷，但这是不可控的副作用。理想情况是在保持带限特性的同时实现噪声动画。

## 流动噪声

保持带限特性的动态噪声解决方案是动画化梯度噪声的底层梯度。Ken Perlin与Fabrice Neyret在2001年Siggraph非正式论文《Flow Noise》[https://inria.hal.science/inria-00537499/file/sketch_col.pdf]中提出：在2D中统一旋转所有梯度，视觉结果将是"蜿蜒旋涡状噪声"。这种效果难以言传且静态图无法展示，但下图链接了在线动画版本。本章相关图像都将提供此选项。

![2506293821 ](https://blogimgbeg.oss-cn-shanghai.aliyuncs.com/2025/06/29/1mg/2506293821-.png) 
*梯度旋转噪声及其随机实验效果*


旋转梯度思想可延伸至3D噪声，前述**_pardnoise_** [Journal of Computer Graphics Tools 2022, https://jcgt.org/published/0011/01/02/]实现了这点。这类噪声变体是许多动画图案的理想起点。

## 湍流现象

湍流（旋涡）是流体中出现的复杂而视觉丰富的现象。湍流与下一章的主题"波动"相关，但波动通常有主导频率，而湍流本质是*混沌*效应，往往跨越多尺度呈现。风驱水波始于小涟漪，以自下而上方式积累能量；湍流则反向传递能量——大旋涡遭遇静止介质时动能衰减，激发反向小旋涡，后者又产生更小旋涡，直至介质粘性将最小旋涡耗散为热。水中湍流止于厘米级，而低粘度的空气湍流可持续至亚毫米级。

> "大涡旋孕育小涡旋，小涡旋又滋生更小的涡旋，直至粘性终结这一切"
——Lewis Fry Richardson，1920年著作《数值方法天气预报》中的诗句


事实上，经典"四大元素"（水、气、火、土）的视觉细节多源于湍流。水体内部和表面都会产生湍流，多数水波由湍流引起；作为水之对立面的火焰（基于古希腊错误理论）也是湍流现象，燃烧与热膨胀引发剧烈内部运动；空气几乎处处存在自然湍流，缓慢宏大的表现即"天气"；土壤沙石则受空气和水流的湍流侵蚀塑造。

透明介质（如水、空气）中的湍流不总是直接可见，但能产生惊人次级效应。下图展示数例——烟团或水涡数秒形成，天气系统数日发展，岩石侵蚀需数百万年，但皆由湍流所致。

![2506294015 ](https://blogimgbeg.oss-cn-shanghai.aliyuncs.com/2025/06/29/1mg/2506294015-.png)
*湍流的可见效果（随机示例）*

湍流研究虽持续数世纪，科学界仍未穷尽其奥秘。本书不深入湍流理论，仅总结关键特征：

湍流源于流体中的大尺度扰动形成旋涡（*涡流*）。当稳定*层流*足够剧烈时，摩擦和粘性会自发随机产生涡流。一旦涡流形成，将引发更多涡流，使流动至少部分混沌。最大旋涡的位置、尺寸和方向与流道形状、流向及障碍物相关；但随着次级旋涡变小，其位置和方向更趋随机。若允许湍流在大体积中长期发展，可呈现完全随机状态——这使其特别适合用程序化噪声模拟。

湍流中旋涡尺寸与速度存在强关联。虽非绝对（涡流内部速度受初如流速和压力梯度影响），但因小涡流实质"骑乘"于大涡流表面，它们往往同速移动。不过其*旋转*速度遵循简单标度律：角速度与尺寸成反比。这是因为不同尺度涡流在边缘直接接触，其周界速度在各尺度上大体一致，直至粘性开始耗散动能。


##  流动噪声再探
在第11章《噪声》中，我们曾沿前置项的梯度扭曲噪声后续项，构建类分形和，称之为"流动噪声"。本章将揭示该名称的由来——当我们开始动画化psrdnoise（或其他具备相同能力的噪声函数）中控制噪声梯度旋转的参数，并沿前置项梯度扭曲后续项时，只要精确调整动画参数，结果会与空气或水中的湍流极为相似。

用正弦函数演示可能更清晰：$\sin(x)$的导数是$\cos(x)$，用函数负导数位移定义域即计算$\sin(x-a\cos(x))$。下图展示$a=0.7$的强烈扭曲效果。
![2506294426 ](https://blogimgbeg.oss-cn-shanghai.aliyuncs.com/2025/06/29/1mg/2506294426-.png)
*扭曲函数的定义域以展平波谷并锐化波峰*


## 烟雾与云层模拟

通过沿前置项累积梯度对**psrdnoise**（或类似函数）各项进行基础扭曲，能惊人地逼真模拟翻滚的烟雾或云层——具体效果取决于动画速度控制。详见下页图像与着色器代码。

```glsl
uniform float time; // Current time in seconds
...
float freq = 4.0;
float amp = 1.0;
float n = 0.0;
vec2 g, gsum = vec2(0.0);
for (int i=0; i<5; i++) {
	n += amp*psrdnoise(uv*freq+gsum*0.15, vec2(0.0), 0.5*time*freq, g);
	gsum += g*amp;
	freq *=2.0;
	amp *= 0.5;
}
vec3 smokecolor = vec3(0.5 – n*0.35);
```

![2506294552 ](https://blogimgbeg.oss-cn-shanghai.aliyuncs.com/2025/06/29/1mg/2506294552-.png) 
*"流动噪声"生成的2D云状翻滚纹理。动画版见[https://www.shadertoy.com/view/fdfcWs](https://www.shadertoy.com/view/fdfcWs)*

虽然纹理中无明显可辨识的细节旋转，但图案仍强烈传递出漩涡运动感。部分原因在于：我们通常观察到的湍流表面，只有少数涡流的旋转轴与表面正交。其他方向的旋转涡流看起来并不像旋转涡旋，而是形成翻滚效果，因此流动噪声与实际湍流的视觉相似度可以非常高。

这种技巧奏效的另一原因在于：人类视觉系统对复杂运动模式的辨识能力有限。我们通过整体外观分类所见事物，只要细节没有明显"违和"，往往会忽略具体差异。某些技术上的显著区别可能无法被人眼察觉，非专业观察者尤其如此。只要能为目标观众创造主观相似性就足够了——这正揭示了程序化方法乃至整个计算机图形学的核心要义：视觉效果必须出色。



## 逆向流动噪声

当明亮区域被拉伸而暗部区域在之间皱缩时，基于梯度的噪声位移会呈现湍流烟雾或云层效果。若将完全相同的图案反相，则变成暗背景上的明亮细丝，类似火焰或表面泡沫。但要实现泡沫动画效果，时序也需反转——波浪水面上的泡沫在小尺度特征上保持稳定，但大尺度上会扭曲变化。如果我们简单地使小尺度梯度旋转动画变慢而非加快，动画图案的视觉印象将完全不同。下图是实现此效果的着色器渲染，静态图中其实只是将前述烟雾着色器的明暗色调互换，真正差异在于动画表现。

![2506292719 ](https://blogimgbeg.oss-cn-shanghai.aliyuncs.com/2025/06/29/1mg/2506292719-.png)
*"流动噪声"生成的2D泡沫状纹理。动画版见[https://www.shadertoy.com/view/7sBcRG](https://www.shadertoy.com/view/7sBcRG)*

该图案的GLSL代码与前述烟雾着色器几乎相同，仅两项区别：各项动画速度调整与色彩映射反转
```glsl
n += amp*psrdnoise(uv*freq+gsum*0.14, vec2(0.0), 8.0*time/freq, g);
...
vec3 foamcolor = mix(vec3(0.0,0.2,0.6), vec3(1.0), 0.5 - n*0.35);
```

## 火焰效果模拟

某些湍流现象由介质内部释放的能量产生。计算机图形学与特效中最常见的当属*火焰*——它是悬浮在空气中的微小颗粒、气溶胶液滴或可燃气体的燃烧过程。由于其剧烈且瞬变的运动特性（如爆炸），火焰成为 notoriously difficult（ notoriously difficult）的模拟对象，但通过各类程序化噪声可模仿其视觉特征。火焰的"活跃度"既反映内部能量释放强度，也暗示其物理尺寸。正如本章开头"速度与尺度"章节所述，真实火焰的上升速度和闪烁频率通常比大众预期更剧烈。火焰色彩也比卡通描绘单调许多——平静的篝火通常只是单纯的橙黄色，虽然强度变化让我们误以为色彩更丰富。相机通常难以处理极端对比度，高光区域容易丢失色相，而计算机图形常需刻意模拟这种"相机视角"效果。

火焰着色器是那种永远无法"完成"的项目——总有需要改进、泛化或纯粹觉得好玩而修改的地方。尽管总觉"未完成不宜展示"，下页仍呈现了一个模拟湍流火焰的动画着色器静帧。这个纯2D函数使用了第11章的*pardnoise*六次调用，配合梯度扭曲、阈值化和取巧的色彩映射。静帧效果平平，但动画版本相当逼真——当然与真实火焰视频对比就相形见绌了。欢迎随意修改代码进行优化、泛化或魔改，这终究只是个永不"完工"的演示。

设计该动画时遵循了若干物理经验法则：
1. 使用多尺度噪声重现湍流特性
2. 所有项同速上移模拟热气上升
3. 动画化*pardnoise*的旋转梯度改变火焰细节，大尺度项慢速变化、小尺度项快速变化，模拟湍流中小涡流转速更快、生灭更快的特性
4. 木材等固体燃料产生的火焰羽流是破碎抖动的上升热气，燃烧发光主要发生在气流与空气接触的表面，因此虚构的2D火焰羽流边缘更亮，与暗背景形成锐利过渡

为增强火焰边缘的漩涡感，噪声求和中后续项的位移不沿前置项梯度$(g_x,g_y)$，而是其正交方向$(-g_y,g_x)$。这种微妙调整赋予火焰更强烈的"愤怒"动感。若用比火焰渲染项更大尺度的旋转梯度进行额外位移，还能增加"湍流"效果。

![2506293034 ](https://blogimgbeg.oss-cn-shanghai.aliyuncs.com/2025/06/29/1mg/2506293034-.png)
*基于2D噪声的动画"火焰"着色器。动态效果远胜静帧。动画版见[https://www.shadertoy.com/view/4XtfWB](https://www.shadertoy.com/view/4XtfWB)*

火焰着色器中，时机把控至关重要——动画的每个细节都影响幻觉营造，微小参数变化可能彻底破坏真实感。获得理想效果需要大量实验。

更优的火焰着色器可采用3D噪声配合体积渲染，但多层2D火焰也能胜任。方法选择取决于真实感需求与渲染速度的权衡。

火焰着色器过于复杂，本书作为入门教材不宜深入。最后需指出：相比标准做法——使用有明显循环段、可能尺度失调、甚至同一场景多个火焰共用不加随机偏移的预制火焰视频，许多程序化方法提供了有趣的替代方案。
