
本章专攻波主题（主要是水波），作为前章《Animation》的直接延续。鉴于波的复杂性，其值得独立成章——至少避免前章过于冗长。

## 波动现象基础

各类波动无处不在，尽管多数不可见（如声波、无线电波）。光本质是电磁波，但计算机图形学通常不考虑光的波动性，仍沿用经典几何光学的"光线+强度+色彩"模型或场景中穿梭的"光子"模型——二者都不尽完美。

光的波动性通过*干涉*显现，当场景特征尺寸接近光波长（数百纳米）时尤为明显，在激光等相干光或偏振光下表现最强。当前计算机图形学很少处理相干/偏振光。薄膜干涉应用于光学滤光片和特殊涂料，最著名的当属水面油膜的"彩虹色"反射。这类效果对当代图形学构成挑战，核心问题在于色彩被粗糙表示为红绿蓝三宽带分量的组合——这虽能模拟视觉色彩感知，但作为照明与反射的光谱分布模型则力有不逮。虽然能处理宽带光谱分布，但对干涉等窄带波长相关效应，RGB表示无能为力。解决方案是采用更好的光谱表示法。随着算力提升，*高光谱*模型（使用远多于三个通道表示"色彩"）将带来显著改进。

本书不深入光的波动特性，仅指出RGB近似并非放之四海皆准。

## 水面波纹模拟

最引人注目的可见波动当属水面波纹。要逼真表现水面，波纹模拟至关重要。常接触水体的人类观察者对"失真"水面极其敏感，尽管通常说不出具体问题所在。这种幻觉很大程度上取决于动画效果——水波运动受完全可建模的物理规律支配，但我们也能利用这些规律知识创建"伪"水波，避免昂贵仿真。

### Gerstner waves

水面波纹具有*Gerstner waves*（严格称*旋轮线波*）剖面，这是*重力波*数学模型的精确解——描述仅受重力和惯性影响的无限深不可压缩均匀液体表面的波动。小振幅时呈正弦波，当振幅接近波长时波峰变尖而波谷保持平坦。约一个波长深度的浅水区或高振幅情况下，波形改变、速度变化并趋向破碎，本章不作讨论。

![2506293537 ](https://blogimgbeg.oss-cn-shanghai.aliyuncs.com/2025/06/29/1mg/2506293537-.png) 
*振幅递增的Gerstner Waves。当峰谷振幅达$\lambda/\pi$时波峰形成尖点，继续增加能量将导致波浪破碎*

波浪的脊状轮廓对大尺度特征的真实感至关重要，但典型水体包含多方向传播的不同波长波纹，对小尺度细节而言，正确模拟振幅和速度更为关键。理想化重力波的物理特性表明：其频率与波长的平方根成反比。满足该频率-波长关系的简单正弦波表示为：

$$
y = \sin\left(2\pi\left(\frac{1}{\lambda}x - \sqrt{\frac{g}{2\pi\lambda}}t\right)\right)
$$

其中$x$为位置，$t$为时间，$\lambda$为波长，$g$为重力加速度（地球约$9.8m/s^2$）。这种波长与速度的平方根关系意味着：大波浪*振荡*更慢，但*传播*绝对速度更快——大浪会超越小涟漪，看似从"下方"穿过。

该方程规定了重力波频率与波长的绝对关系，对真实感至关重要。地球上波长为$\lambda$米的重力波，频率$f=\sqrt{g/(2\pi\lambda)}$Hz，相速度$f\lambda=\sqrt{g\lambda/(2\pi)}$。概数而言：1米波以约1.25Hz振荡，传播速度约1.25m/s；10米波以约0.4Hz（每2.5秒一个波）振荡，传播速度约4m/s。人们会无意识地通过振荡（"上下"）和传播（"移动"）速度判断水波尺寸，动画中弄错任一速度都是常见错误。

着色器模拟需注意：水波具有强非线性——高振幅时更甚。不同方向的强波相遇时不仅产生临时干涉，还会持久相互影响。由于速度差异，水波频率也随时间*色散*。大振幅波会压制小波传播并吸收其能量，而方向相近的不同波长波可能自发合并为单一波长的更高波——这正是风能掀起巨浪的原因。

Tessendorff 2001年发表的海洋波论文[https://people.computing.clemson.edu/~jtessen/reports/papers_files/coursenotes2004.pdf]常被引用，此处不深入理论。我们将提供着色器友好的格斯特纳波近似，因其精确形状难以用着色器友好形式表达。

### 伪Gerstner waves

格斯特纳波的剖面是*旋轮线*（又称*摆线*），易用参数方程表示。以相位角$\phi$为参数，$2\pi a$为波长，$2b$为峰峰值振幅：

$$
\begin{cases} 
x = a\phi + b\cos\phi \\
y = b\sin\phi 
\end{cases}
$$

![2506292804 ](https://blogimgbeg.oss-cn-shanghai.aliyuncs.com/2025/06/29/1mg/2506292804-.png)
*格斯特纳波中单个粒子作圆周运动。动画演示见[https://www.shadertoy.com/view/MXtfDr](https://www.shadertoy.com/view/MXtfDr)*

参数形式易在位移着色器中实现，但需以非参数形式$y=f(x)$表达时（如计算凹凸贴图）则成问题。核心难点在于需反解$x=a\phi+b\cos\phi$求$\phi$来计算$y$——这涉及需数值求解的椭圆积分，近似解可能相当繁琐。

但计算机图形学可接受视觉合理的近似结果。基于此，我们可在$[-\pi/2,\pi/2]$区间对$\cos\phi$进行粗略近似：

$$
\cos\phi \approx 1-(2\phi/\pi)^2
$$

这足以计算波浪上升段。下降段可通过$\phi\in[\pi/2,3\pi/2]$映射到$[-\pi/2,\pi/2]$（替换为$\pi-\phi$）并反转结果符号获得，注意$x$坐标方向需后续反转。如此得到$2\pi$周期（虽偏移到$[-\pi/2,3\pi/2]$）。

用抛物线近似余弦虽粗糙，但保留了关键特性：$\phi=0$对称、$\phi=0$值为1、$\phi=\pi/2$值为0、$\phi=0$零斜率及整体平滑性。差异在于端点斜率更陡（系数$4/\pi$），因此波浪"破碎"（参数表达式开始循环，$y$无法表示为$x$函数）时的$b$值发生在$a\pi/4$而非$a$。我们可通过将$x$方程中的$b$缩放为$b\pi/4$来补偿。结果波形与真实格斯特纳波相似，仅坡度较缓且破碎前波峰较钝。这对视觉影响不大——实际上，最大振幅处较钝的波峰更适合作图需求，定性来看也更接近现实。具有表面张力和非零粘度的物理介质中的重力波永远不会达到无限尖锐的波峰，格斯特纳波虽是流体方程的精确解，但方程假设了现实中不存在的理想条件。

将余弦近似代入$x$表达式，引入物理位置$x_0=a\phi$，将波长改为2（原$2\pi$），最后不失一般性设$a=1$（波长可通过$x$缩放调整），得到：

$$
x = x_0 + b(1 - (2x_0)^2)
$$

此缩放形式下$b$范围为$[0,1/4]$而非$[0,1]$。这是易求逆的简单二次方程，解得：

$$
x_0 = (1 - \sqrt{16b^2 - 16bx + 1})/8b
$$

（舍去不在$x$区间$[-1/2,1/2]$内的另一根）。$b=0$时无波，直接$x_0=x$。

现在，我们可以用$x_0$来计算$x$处的垂直位移。这部分无需近似处理，直接使用标准的正弦函数即可：

$$y = b \sin(\pi x_0)$$

波形的闭合表达式$y=f(x)$可表示为：

$$y = b \sin\left(\pi\left(1-\sqrt{16b^2-16bx+1}\right)/8b\right)$$

然而，横向位移$x_0$是波动中极为关键的特征，应作为独立表达式计算。波的每个质点作圆周运动，波面会随波动伸展收缩。这种横向往复运动会推动水面泡沫或碎屑，而较大漂浮物的运动则因质量和阻力各异。横向位移对波动动画的视觉效果至关重要——尽管简单图形模拟常忽略它，但加入后真实感显著提升。

对于凹凸贴图，曲线的斜率同样重要。该闭合表达式易于微分，其导数为：

$$\frac{dy}{dx} = \frac{\pi b \cos\left(\pi\left(\sqrt{16b^2-16bx+1}-1\right)/8b\right)}{\sqrt{16b^2-16bx+1}}$$

当$b=0$时（因分母$8b$为零），此表达式失效，但此时函数及其导数全为零。当$b=1/4$且$x=0$时（波峰即将破碎处），导数也无定义——此处我们通过镜像近似计算下坡斜率。函数$y=f(x)$在$x=0$两侧有明确定义的导数，但两者不等。（注意：这与真实Gerstner波不同，后者在破碎前的尖峰处斜率为无限大。）图形应用中可灵活处理：微调该点坐标、假设此处斜率为零，或直接限制$b<1/4$。

![2506293226 ](https://blogimgbeg.oss-cn-shanghai.aliyuncs.com/2025/06/29/1mg/2506293226-.png)
*上图展示了模拟Gerstner波与实际Gerstner波的剖面对比，尽管细节差异较大，但视觉相似性很强。下图是通过GLSL着色器渲染的凹凸贴图表面，结合了本文波函数的所有特征及噪声生成的细节。主波振幅从底部零值渐变至顶部最大值。动态演示见：https://www.shadertoy.com/view/13cfWM。*

下文图片展示了一个反光凹凸表面，其凹凸贴图由三类上述噪声构成：纵向拉伸并通过偏移收缩波峰、扩张波谷。每类噪声以$\sqrt{\text{平均波长}}$的比例沿水平方向移动，模拟真实重力波。黄线为等比例高度剖面。实际波高较浅——高光反射强化了视觉效果。模拟光源位于右侧45度角。动态演示更能体现着色器特性，详见图片说明中的链接。

![2506293311 ](https://blogimgbeg.oss-cn-shanghai.aliyuncs.com/2025/06/29/1mg/2506293311-.png)
*使用三类扭曲噪声生成的镜面波浪表面。动态版本见：https://www.shadertoy.com/view/l3cfWM*


## 噪声模拟波浪

基于前文知识，我们可以用噪声成功模拟水波。尖峰和平谷的特征，以及纹理扭曲效果，可通过"流动噪声"的坐标偏移技巧实现：沿噪声值梯度反向偏移纹理坐标，再用偏移后的坐标重新采样同一噪声。这会拓宽波谷并挤压波峰。若将噪声拉伸为椭圆形斑点，并精确控制偏移量以避免纹理坐标自交，效果会相当逼真。

当然，这种对噪声函数的任意扭曲并不符合物理规律，但概念上是正确的——因为它将表面点推离波谷而聚向波峰。当叠加多个分量构建分形波频分布时，效果尚可接受。

![2506293526 ](https://blogimgbeg.oss-cn-shanghai.aliyuncs.com/2025/06/29/1mg/2506293526-.png)  
*左图：噪声及其梯度的首次采样。中图：相同噪声函数在偏移坐标下的采样结果，可见暗区扩张而亮区收缩。右图：无等高线的扭曲噪声效果。*


下页图片展示了一个采用凹凸贴图的反光表面，其凹凸贴图由三类前文所述的噪声构成：沿垂直方向拉伸，并通过扭曲收缩波峰、扩张波谷。每类噪声以$\sqrt{\text{平均波长}}$的比例沿水平方向移动，以模拟真实重力波。黄色线条为等比例高度剖面。实际波浪较浅——高光反射强化了其视觉效果。模拟光源位于右侧45度角。动态演示能更清晰地展现着色器特性，详见说明中的链接。

![2506293910 ](https://blogimgbeg.oss-cn-shanghai.aliyuncs.com/2025/06/29/1mg/2506293910-.png)
*一个由三类扭曲噪声生成的镜面波浪表面。动态版本见：https://www.shadertoy.com/view/XXcfRf*  

为营造海浪的视觉印象，许多着色器作者会聚焦尖峰特征，采用脊状函数构建分形频率和。典型方案包括**cellular**函数结果的平方，或噪声的负绝对值：$\mathbf{1} - \mathbf{abs}(\textit{noise}(p))$。两者虽可行，但生成的尖锐波峰需经圆润化处理以提升真实感。倒置的$\mathbf{abs}(\textit{noise})$需叠加常规噪声以避免波峰等高，而**cellular**生成的笔直波脊需用噪声扭曲以形成自然的波冠形态。关键在于，这些脊状函数仅应用于总和中的大尺度特征，且仅当波浪接近其波长最大振幅时使用——平静海面呈圆润波浪，唯有强浪才会显现尖峰。（没错，这里确实用了分号。认真的。）

## 涟漪

水体中的重力波是一种强烈、持久且传播范围广的现象，这源于水兼具较高密度和较低粘度的特性，使得重力波能承载巨大能量。然而当水面受扰动后，主要存在两种力量使其恢复平滑平衡状态：其一是重力——它主导着波长数厘米以上的较大波纹；但对于波长1厘米以下的微小波纹，主导力量则转变为


*表面张力*。这类波纹被称为*毛细波*，俗称*涟漪*。因其物理机制不同，表现也迥异。表面张力对小尺度特征的影响呈比例增强，这使得短波振荡频率*远高于*长波。与重力波相反，毛细波的传播速度与波长$\lambda$的关系完全倒置：较短的毛细波传播速度*更快*，其相位速度与$\sqrt{\lambda}$成正比，而非重力波的$1/\sqrt{\lambda}$。遗憾的是，毛细波仍具有显著非线性特征——较大振幅时会像重力波一样偏离正弦波形。实际上其剖面呈现倒置的Gerstner波形态，只需将前述方法的位移量取反即可模拟。不过毛细波通常振幅较小、移动迅速且快速消散，其微小尺度和高速运动使得精确剖面形态对渲染效果影响有限，因此采用正弦波剖面往往已足够。

毛细波还更易受粘滞阻尼影响。在无其他扰动的平静水面上，它们仅能传播数米便会消散。但得益于非线性色散效应，这些波纹会聚集形成能传播更远的大浪——这正是风力掀起风暴巨浪的机制：气流掠过静水表面时产生摩擦阻力，形成初始涟漪；这些涟漪又引发气流湍流，进一步扰动水面形成更强湍流，最终催生更大波纹。我们虽不深究其模型原理，但需注意：开阔水域的波浪可能源自远方风力经年累月的作用，且可能来自多个不同方向。

## 复杂情况

遗憾的是，许多具有视觉趣味的波纹属于*重力-毛细波*，发生在厘米尺度范围内——此时重力、表面张力和粘性共同作用。这类波纹的精确模拟相当困难。更复杂的是（此处双关语绝非偶然），在浅水区波速会逐渐与波长脱钩，而冲刷岸线的波浪与浅水区破碎浪都是波浪与分层湍流的复杂混合体。

在1.73厘米这个特定波长下，重力波与毛细波的非线性效应会相互抵消，使得该波长的水波至少在振幅未达破碎极限时，会表现出近似线性波的特征。不过一旦与其他波相互作用，这种表观线性就会瓦解，因此该现象更多是理论趣闻而非实用工具。这个精确波长（1.73厘米）的波纹振荡频率为13.5Hz，其0.23m/s的传播速度是所有水面波中最慢的。综合重力与毛细效应的波速$v$与波长$\lambda$的完整关系式为：

$$v^2 = \frac{g\lambda}{2\pi} + \frac{2\pi y}{\lambda\rho}$$

其中$g$为重力加速度（$9.8 \, m/s^2$），$y$为粘滞系数（纯水约$0.072 \, N/m$），$\rho$为水密度（$10^3 \, kg/m^3$）。大$\lambda$时首项占主导，小$\lambda$时次项起决定作用。

<div style="text-align:center; font-size:1.2em; margin:20px 0;">
<span style="display:block; font-weight:bold;">"水波——这个基础课程中常用的波动范例，恰恰是最糟糕的示例；它囊括了波动现象中所有可能的复杂性。"</span>
<span style="display:block; font-style:italic; margin-top:8px;">
Richard Feynman（为简洁稍作转述）
</span>
</div>




## 模拟涟漪

与重力波类似，毛细波（涟漪）也可以通过一层或多层噪声来模拟——通常沿特定方向拉伸以形成定向波纹，并通过动画匹配真实波浪的运动规律。但涟漪通常不会在大范围内保持均匀，它们由局部扰动（如阵风或溅落）引发，并会随距离快速衰减。因此波纹图案需通过更大尺度的变化进行调制，这种调制同样可基于噪声或与场景元素关联。要创建逼真的程序化动态涟漪，必须包含随距离/时间衰减的特性，以及在波长、强度*和*方向上的显著局部变化。

使用常规梯度噪声虽可模拟涟漪，但会限制图案表现力——特别是难以实现涟漪*方向*的局部变化。所幸程序化噪声本质是数学函数，我们不必拘泥于特定类型，完全可以设计更适合此任务的噪声函数。

在现有噪声类型中，有两种特别适合生成涟漪图案：*Gabor噪声*与*相位噪声*。Gabor噪声由Lagae等人首次提出[https://inria.hal.science/inria-00606821v1, ACM Transactions on Graphics 2009]，相位噪声则由Neyret发表[ACM Transactions on Graphics 2019, https://doi.org/10.1145/3306346.3322990]。二者均属稀疏卷积噪声，通过在点集周围区域"溅射"波形（核函数）生成图案。原始Gabor噪声基于伪随机散射，而相位噪声采用规则网格。相位噪声对波形选择更灵活，能生成更丰富的图案；Gabor噪声则如其名，使用类似*Gabor函数*的波形。*标准*Gabor函数是正弦波与高斯衰减的乘积：

$$g(\bar{x}) = e^{-|\bar{x}|^2 / 2\sigma^2} \cos(2\pi (\bar{x} \cdot \hat{v}) / \lambda + \psi)$$

其中$\bar{x}$表示相对于核原点的表面位置，$\sigma$控制波形空间范围，$\lambda$为波长，$\hat{v}$是波方向的单位向量，$\psi$为相位。变体定义中包含使空间范围呈椭圆状的参数，此处不作展开。实际Gabor噪声与相位噪声使用的衰减因子并非高斯函数，而是类似单纯形噪声的有限半径归零近似。

![2506294535 ](https://blogimgbeg.oss-cn-shanghai.aliyuncs.com/2025/06/29/1mg/2506294535-.png) 
*池塘/水坑等静水表面的阵风涟漪图案（航海术语称"猫爪纹"），这是风力加强区的明显视觉特征。动态演示见：https://www.shadertoy.com/view/wfjGRR*

改用相位噪声可获得更优质灵活的效果——不仅能调节振幅，还能通过缓变噪声函数局部改变涟漪的方向、各向异性和波长，更真实地模拟风对水面的影响。

## 滴落圆环

涟漪的一个重要特例是物体溅落（如投石或雨滴）产生的扩散同心圆环。这类溅落始于冲击力形成的"弹坑"：凹陷被隆起环绕。凹陷回填后，冲击点会持续振荡片刻，强烈初期振荡常引发二次溅射（水滴反弹产生新涟漪）。虽然该过程持续毫秒级且通常无需精确重现，但最显著的视觉元素——持续扩散的大半径圆环——却容易模拟。

![2506294549 ](https://blogimgbeg.oss-cn-shanghai.aliyuncs.com/2025/06/29/1mg/2506294549-.png)
*真实水滴溅落效果。虽然溅落细节复杂，但整体图案较易模拟。*

波长小于1.7厘米时，短波虽传播更快，但可能被前方长波的非线性效应阻挡。这会导致扩散圆环外缘形成明显波峰，内部伴随若干渐弱波峰，环内区域相对平静。在未衰减的强主涟漪经过区域，原有小涟漪会被暂时抑制——反直觉的是，溅落反而可能创造短暂的局部静水区。

![2506294602 ](https://blogimgbeg.oss-cn-shanghai.aliyuncs.com/2025/06/29/1mg/2506294602-.png)
*模拟雨滴水面涟漪的扩散圆环。动态演示见：https://www.shadertoy.com/view/wflGWM*

溅落会在后方留下临时静水区，类似现象也出现在船只*尾流*之间——较弱短波无法穿越尾流强峰，且尾流作为持续获能的线性重力波，衰减远慢于溅落毛细波。尾流可传播极远，其内侧水面会长时间保持平静，直到新波纹形成或从外部传入。船只近处的尾流模拟重在湍流效应（如船体破水产生的水花），而远距离长效影响非常适合着色器模拟。浮物/岸线造成的波纹反射也可用相位噪声模拟，我们将在终章《混合技法》简要讨论。


## 反射与折射

除局部反射模型中的高光外，反射本质上属于*全局光照*效应，折射亦是如此。二者都需要场景中其他物体的信息来呈现反射/折射内容。不过计算机图形学始终擅长"造假"，我们仍有办法在表面着色器中实现这两种效果。基于屏幕空间的技术能较好模拟折射，反射则稍逊——至少通用性较低。我们暂不深究这些技术，而是聚焦如何在表面着色器中伪造这些效果。

如同本书其他内容，这里介绍的方法未必最优，但属于*程序化*方案，且*可能*表现不俗。

镜面反射难以伪造，更适合通过场景空间方法实现（远不止程序化表面着色器这么简单）。但若表面凹凸不平，使用*反射贴图*这种传统技巧往往就足够了——贴图无需精确还原真实环境，只需保持相近色调与整体风格即可（极端案例：展现蓝天白云的反射贴图显然不适用于室内场景）。当然，反射贴图本身可以是程序化生成的，这虽非主流方案（通常需预渲染阶段从物体近似视角生成环境贴图），却具有独特优势。

折射与反射物理原理相同，但对视觉表现的影响截然不同。反射内容常位于摄像机视野外，因反射表面形状不规则且多呈凸面，通常呈现扭曲缩小的形态。加之可能存在的模糊与低强度特性，使其并非视觉焦点，故而更容易"蒙混过关"。而折射关乎透明物体背后的可见内容，这些内容常在不被遮挡处清晰可见，且位于视线主方向上，必须逼真呈现。*折射贴图*能解决部分问题，但实现难度与通用性远不及反射贴图。实时图形学中的折射效果传统上需双渲染通道：首通道处理非透明物体的颜色与深度，次通道将首通道结果作为纹理，叠加带折射效果的透明物体。

![2506295021 ](https://blogimgbeg.oss-cn-shanghai.aliyuncs.com/2025/06/29/1mg/2506295021-.png)
*完全取巧的游泳池模拟。动态演示见：https://www.shadertoy.com/view/sslcWf*

不过存在一种程序化实现方案值得关注：当透明物体后方内容易于确定时（如角膜后的虹膜、浅水下的池底、画框玻璃后的画作），表面着色器可同时处理透明表面反射/折射与后方表面渲染。这无需额外通道与纹理存储，只需着色器知晓两个表面的信息并进行折射光线计算。本质上，着色器就此简化为仅认知两个物体的微型光线追踪器。出于性能考虑，追踪过程需保持简短——可采用有限步数的迭代（但需避免传统光追的递归，因GLSL等语言目前不支持实时递归，且会增加计算时长不确定性）。

更逼真（但仍非完全真实）的游泳池示例如下。水面着色器实施凹凸贴图处理：发射反射光线至简易程序化天空穹顶计算反射，追踪折射光线至池底渲染折射。池体尺寸与瓷砖图案均硬编码在着色器中——其计算量甚至低于波纹噪声与天空噪声。虽然代码结构混乱（在非光追框架内硬编码物体实现光线追踪），但确实达成了效果。

![2506295111 ](https://blogimgbeg.oss-cn-shanghai.aliyuncs.com/2025/06/29/1mg/2506295111-.png)
*相对逼真的游泳池模拟。动态演示见：https://www.shadertoy.com/view/wfSXRw  
为展示原理刻意简化渲染，未包含阴影。*

此方法的独特优势在于可轻松模拟浑浊水体（通过水中光路的指数衰减计算）。主要缺陷是未硬编码入着色器的物体在水中会"消失"。虽属取巧方案，但在特定场景下非常实用。



## 焦散效应

前文渲染示例为单独展示折射与反射效果，刻意简化未包含阴影，但也因此显得平面化不真实。实际场景中，反射与折射不仅影响"相机光线"（从表面到观察者的光路），还会影响"光源光线"（从光源到表面的路径），这类效应统称为*焦散*。焦散可以是反射型、折射型或混合型。下页展示真实世界中的焦散案例。

![2506295215 ](https://blogimgbeg.oss-cn-shanghai.aliyuncs.com/2025/06/29/1mg/2506295215-.png)
*现实水波产生的反射与折射焦散。*

虽然任何反射/透明表面都可能产生焦散，但本章聚焦水波。若要以程序化方式模拟焦散，每种物体都需要特定处理方案——例如水波焦散的模拟方法就与玻璃截然不同。

在传统"逆向光线追踪"中，焦散根本不可能被建模，即便采用特殊方法模拟也难以完美。最著名的成功案例是Jensen于1996年提出的光子映射技术[http://graphics.ucsd.edu/~henrik/papers/photon map/global illumination using photon maps egwr96.pdf]，该方法通过预渲染通道从选定光源进行正向光追，记录光线经镜面反射/折射后首次接触漫反射表面的命中点，将其存入场景关联的"点云"数据结构用于光照计算。

当然我们也可以取巧。观众通常不会深究焦散的精确形态，关键在于图案的整体特征、细节尺寸以及最重要的——运动时序。观察前文示例，这些图案与之前章节的某些噪声实验颇为相似。尝试用"流动噪声"变体模拟焦散的示例如下：

![2506295227 ](https://blogimgbeg.oss-cn-shanghai.aliyuncs.com/2025/06/29/1mg/2506295227-.png) 
*模拟焦散效果。带源码的演示见：https://www.shadertoy.com/view/wfjSDG*

上述着色器利用噪声导数生成特征图案，但这绝非唯一方案。经典且更简单的方法是阈值化动态噪声，在零值附近渲染宽泛模糊的等值线——注意避免精确取零值，否则会暴露底层网格结构。

另一个值得探索的方案是基于噪声凹凸函数的二阶导数。这并非突发奇想——存在物理依据：焦散光强变化源自反射/折射"光线"的角度密度不均，而密度又取决于表面曲率（即二阶导数）。虽不宣称模拟任何真实现象，下图展示了两种完全虚构但"类焦散"的程序化图案：

![2506295240 ](https://blogimgbeg.oss-cn-shanghai.aliyuncs.com/2025/06/29/1mg/2506295240-.png)
*两种基于二阶导数的虚构焦散图案，左图采用标准噪声，右图使用各向异性变形噪声。*


## 傅里叶合成

在信号与图像分析中，多尺度波动图案常通过*功率谱*（能量随波长的分布）来表征。功率谱是信号傅里叶变换幅值的平方，它忽略相位信息，对于描述具有跨尺度相关性的图像（实际上大多数图像皆如此）显得过于笼统。但对于某些类噪声图案却非常实用。早在第10章我们就演示过*加性频谱合成*——将不同频率、随机相位的波叠加。更通用的方法是*直接傅里叶合成*：通过对功率谱开方作为振幅分量，并赋予随机初始相位后随时间变化以形成波动，再使用快速傅里叶变换（FFT）算法进行离散傅里叶逆变换（DFT）直接生成图案。这并非"纯正"的程序化方法，因其需要预计算并存储整幅图像——受FFT算法限制，无法高效计算单点逆DFT值，必须整图处理。不过该方法仍适用于模拟复杂波场（如海面），且生成的图像天然具备周期性无缝平铺特性。

传统教材常警告称逐帧进行傅里叶逆变换生成纹理对实时应用而言计算代价过高，但如今这已不成问题。傅里叶逆变换的计算复杂度与JPEG图像解压相当，现代计算机完全能实时处理。虽非易事，但确有可能——FFT算法可编程在现代GPU的计算着色器中运行，甚至能以迂回方式塞入片段着色器。

傅里叶合成能创建具有任意波长/波向分布的高度逼真海浪。结合丰富的海洋学数据生成功率谱，该方法被广泛应用于实时海洋波浪可视化模拟及离线特效制作。我们在此不展示具体示例，但网络搜索"FFT ocean waves"可获得大量优质资源——从具体工具教程到科学海洋数据。创造逼真海浪模拟的艺术已远超本书入门级范畴，故本章到此为止。

（哎，正到精彩处却要结束了！）






